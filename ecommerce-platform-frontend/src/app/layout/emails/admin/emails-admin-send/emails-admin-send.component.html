<div class="email-send-container">
  <div class="admin-header-section list-header">
    <div class="admin-header-content">
      <div class="admin-title-section">
        <h1>{{ 'EMAILS.SEND_TITLE' | translate }}</h1>
        <p class="admin-subtitle">{{ 'EMAILS.SEND_SUBTITLE' | translate }}</p>

        <!-- Template Status Indicator -->
        <div class="template-status" *ngIf="!isInitializing && !loadError">
          <button
            *ngIf="!templatesLoaded"
            (click)="navigateToTemplates()"
            class="configure-btn admin-action-btn templates-btn"
            mat-button>
            <mat-icon>settings</mat-icon>
            {{ 'EMAILS.CONFIGURE_TEMPLATES' | translate }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Initial Loading -->
  <div *ngIf="isInitializing" class="loading-section">
    <mat-progress-bar mode="indeterminate"></mat-progress-bar>
    <div class="loading-text">{{ 'EMAILS.LOADING_TEMPLATES' | translate }}</div>
  </div>

  <!-- Load Error State -->
  <div *ngIf="loadError && !isInitializing" class="error-section">
    <mat-icon class="error-icon" color="warn">error_outline</mat-icon>
    <div class="error-text">{{ loadError }}</div>
    <div class="error-actions">
      <button
        (click)="retryLoadTemplates()"
        color="primary"
        mat-raised-button>
        <mat-icon>refresh</mat-icon>
        {{ 'COMMON.RETRY' | translate }}
      </button>
      <button
        (click)="navigateToTemplates()"
        color="accent"
        mat-stroked-button>
        <mat-icon>settings</mat-icon>
        {{ 'EMAILS.CONFIGURE_TEMPLATES' | translate }}
      </button>
    </div>
  </div>

  <div class="form-content-container" *ngIf="!isInitializing && !loadError">
    <form *ngIf="emailForm" (ngSubmit)="sendEmail()" [formGroup]="emailForm" id="emailForm">
      <div class="form-content">
        <mat-progress-bar *ngIf="isLoading" class="admin-save-progress" mode="indeterminate"></mat-progress-bar>

        <!-- Email Type Selection -->
        <div class="form-section">
          <div class="section-header">
            <mat-icon>drafts</mat-icon>
            <h3>{{ 'EMAILS.EMAIL_TYPE' | translate }}</h3>
            <span class="template-indicator success" *ngIf="selectedEmailType && hasTemplateContent()">
              <mat-icon class="has-content">check_circle</mat-icon>
              {{ 'EMAILS.TEMPLATE_LOADED' | translate }}
            </span>
            <span class="template-indicator warning" *ngIf="selectedEmailType && !hasTemplateContent()">
              <mat-icon>warning</mat-icon>
              {{ 'EMAILS.NO_TEMPLATE_CONTENT' | translate }}
            </span>
          </div>

          <div class="form-row">
            <div class="form-field">
              <mat-form-field appearance="outline" class="email-type-select">
                <mat-label>{{ 'EMAILS.SELECT_EMAIL_TYPE' | translate }}</mat-label>
                <mat-select [(value)]="selectedEmailType" (selectionChange)="onEmailTypeChange()">
                  <mat-option *ngFor="let type of availableEmailTypes" [value]="type">
                    <div class="email-type-option">
                      <span>{{ getEmailTypeDisplayName(type) }}</span>
                      <mat-icon
                        *ngIf="emailTemplates.get(type)?.localizedFields && Object.keys(emailTemplates.get(type)!.localizedFields).length > 0"
                        class="option-loaded">
                        check_circle
                      </mat-icon>
                    </div>
                  </mat-option>
                </mat-select>
                <mat-icon matSuffix>arrow_drop_down</mat-icon>
              </mat-form-field>
            </div>

            <!-- Language Selection -->
            <div class="form-field">
              <mat-form-field appearance="outline" class="language-select">
                <mat-label>{{ 'EMAILS.EMAIL_LANGUAGE' | translate }}</mat-label>
                <mat-select [(value)]="selectedLanguage" (selectionChange)="onLanguageChange()">
                  <mat-option *ngFor="let locale of usedLocales" [value]="getLocaleString(locale)">
                    {{ locale.translatedName }}
                  </mat-option>
                </mat-select>
                <mat-icon matSuffix>language</mat-icon>
              </mat-form-field>
            </div>
          </div>
        </div>

        <!-- Recipient Selection -->
        <div class="form-section">
          <div class="section-header">
            <mat-icon>people</mat-icon>
            <h3>{{ 'EMAILS.RECIPIENTS' | translate }}</h3>
          </div>

          <!-- Customer Search -->
          <div class="form-field full-width">
            <mat-form-field appearance="outline" class="customer-search">
              <mat-label>{{ 'EMAILS.SEARCH_CUSTOMERS' | translate }}</mat-label>
              <input
                matInput
                [formControl]="customerSearchControl"
                [matAutocomplete]="auto"
                placeholder="{{ 'EMAILS.SEARCH_BY_NAME_EMAIL' | translate }}">
              <mat-icon matSuffix>search</mat-icon>
              <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayCustomer">
                <mat-option
                  *ngFor="let customer of filteredCustomers | async"
                  [value]="customer"
                  (onSelectionChange)="onCustomerSelect(customer)">
                  <div class="customer-option">
                    <div class="customer-info">
                      <span class="customer-name">{{ customer.firstName }} {{ customer.lastName }}</span>
                      <span class="customer-email">{{ customer.email }}</span>
                      <span class="customer-language" *ngIf="customer.preferredLanguageId">
                        {{ getCustomerLanguage(customer) }}
                      </span>
                    </div>
                    <mat-icon *ngIf="isCustomerSelected(customer)" class="selected-icon">check_circle</mat-icon>
                  </div>
                </mat-option>
              </mat-autocomplete>
            </mat-form-field>
          </div>

          <!-- Selected Recipients -->
          <div class="selected-recipients" *ngIf="selectedCustomers.length > 0">
            <div class="section-subtitle">
              <h4>{{ 'EMAILS.SELECTED_RECIPIENTS' | translate }}</h4>
              <span class="recipients-count">({{ selectedCustomers.length }})</span>
            </div>
            <div class="recipients-list">
              <div *ngFor="let customer of selectedCustomers" class="recipient-chip">
                <div class="recipient-info">
                  <span class="recipient-name">{{ customer.firstName }} {{ customer.lastName }}</span>
                  <span class="recipient-email">{{ customer.email }}</span>
                  <span class="recipient-language" *ngIf="customer.preferredLanguageId">
                    {{ getCustomerLanguage(customer) }}
                  </span>
                </div>
                <button
                  (click)="removeCustomer(customer)"
                  class="remove-btn action-btn"
                  mat-icon-button>
                  <mat-icon class="remove-icon">close</mat-icon>
                </button>
              </div>
            </div>

            <div class="recipient-actions">
              <button
                (click)="clearSelection()"
                class="clear-btn"
                mat-button>
                <mat-icon>clear_all</mat-icon>
                {{ 'EMAILS.CLEAR_ALL' | translate }}
              </button>
            </div>
          </div>
        </div>

        <!-- Email Content -->
        <div class="form-section" *ngIf="selectedEmailType">
          <div class="section-header">
            <mat-icon>email</mat-icon>
            <h3>{{ 'EMAILS.EMAIL_CONTENT' | translate }}</h3>
          </div>

          <!-- Subject -->
          <div class="form-field full-width">
            <mat-form-field appearance="outline">
              <mat-label>{{ 'EMAILS.SUBJECT' | translate }}</mat-label>
              <input
                matInput
                [(ngModel)]="emailSubject"
                [formControl]="subjectControl"
                [placeholder]="'EMAILS.SUBJECT_PLACEHOLDER' | translate"
                maxlength="200">
              <mat-hint align="end">{{ emailSubject?.length || 0 }}/200</mat-hint>
              <mat-error *ngIf="subjectControl.hasError('required')">
                {{ 'VALIDATION.REQUIRED' | translate }}
              </mat-error>
            </mat-form-field>
          </div>

          <!-- Body -->
          <div class="form-field full-width">
            <mat-form-field appearance="outline" class="email-body">
              <mat-label>{{ 'EMAILS.BODY' | translate }}</mat-label>
              <textarea
                matInput
                [(ngModel)]="emailBody"
                [formControl]="bodyControl"
                [placeholder]="'EMAILS.BODY_PLACEHOLDER' | translate"
                rows="8"
                maxlength="5000">
              </textarea>
              <mat-hint align="end">{{ emailBody?.length || 0 }}/5000</mat-hint>
              <mat-error *ngIf="bodyControl.hasError('required')">
                {{ 'VALIDATION.REQUIRED' | translate }}
              </mat-error>
            </mat-form-field>
          </div>

          <!-- Template Variables -->
          <div class="template-variables" *ngIf="availableVariables.length > 0">
            <h4>{{ 'EMAILS.TEMPLATE_VARIABLES' | translate }}</h4>
            <p class="variables-description">{{ 'EMAILS.VARIABLES_DESCRIPTION' | translate }}</p>
            <div class="variables-list">
              <span
                *ngFor="let variable of availableVariables"
                (click)="insertVariable(variable)"
                class="variable-tag">
                {{ getVariableDisplayName(variable) | translate }}
              </span>
            </div>
          </div>

          <!-- Preview Toggle -->
          <div *ngIf="selectedCustomers.length > 0" class="form-row checkboxes-row">
            <div class="checkbox-group">
              <mat-checkbox formControlName="showPreview" (change)="onPreviewToggle()">
                {{ 'EMAILS.ADMIN.SHOW_PREVIEW' | translate }}
              </mat-checkbox>
            </div>
          </div>

          <!-- Email Preview -->
          <div [@previewToggle]="showPreview ? 'visible' : 'hidden'" class="animated-form-content">
            <div class="form-row" *ngIf="selectedEmailType && selectedCustomers.length > 0">
              <div class="email-preview">
                <h4>{{ 'EMAILS.PREVIEW' | translate }}</h4>
                <div class="preview-content">
                  <div class="preview-header">
                    <strong>{{ 'EMAILS.TO' | translate }}:</strong>
                    <span class="preview-recipients">
                      {{ getRecipientEmailsPreview() }}
                    </span>
                  </div>
                  <div class="preview-subject">
                    <strong>{{ 'EMAILS.SUBJECT' | translate }}:</strong> {{ emailSubject || ('EMAILS.NO_SUBJECT' | translate) }}
                  </div>
                  <div class="preview-body">
                    <strong>{{ 'EMAILS.BODY' | translate }}:</strong>
                    <div class="html-preview" [innerHTML]="getPreviewBody() | safeHtml"></div>
                  </div>
                  <div class="preview-note">
                    <mat-icon>info</mat-icon>
                    <span>{{ 'EMAILS.PERSONALIZATION_NOTE' | translate }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </form>

    <!-- Floating Action Buttons -->
    <div class="admin-actions-bar">
      <div class="admin-action-buttons">
        <button (click)="cancel()"
                color="warn"
                mat-stroked-button
                type="button"
                class="cancel-btn">
          <mat-icon>close</mat-icon>
          {{ 'COMMON.CANCEL' | translate }}
        </button>
        <button [disabled]="!canSendEmail() || isLoading"
                color="primary"
                form="emailForm"
                mat-flat-button
                type="submit"
                class="save-btn">
          <mat-icon>send</mat-icon>
          {{ isLoading ? ('EMAILS.SENDING' | translate) : ('EMAILS.SEND_EMAIL' | translate) }}
        </button>
      </div>
    </div>
  </div>

  <!-- Sending Loading State -->
  <div *ngIf="isLoading" class="loading-section">
    <mat-progress-bar mode="indeterminate"></mat-progress-bar>
    <div class="loading-text">{{ 'EMAILS.SENDING_EMAILS' | translate }}</div>
  </div>
</div>
