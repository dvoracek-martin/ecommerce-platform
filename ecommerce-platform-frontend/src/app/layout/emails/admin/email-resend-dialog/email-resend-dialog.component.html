<div class="email-resend-dialog-container">
  <!-- Header -->
  <div class="dialog-header">
    <div class="header-content">
      <mat-icon class="header-icon">email</mat-icon>
      <h2 class="dialog-title">
        {{ isViewMode() ? 'View Email Details' : 'Resend Email with Adjustments' }}
      </h2>
    </div>
    <button mat-icon-button (click)="close()" class="close-button">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <!-- Content -->
  <div class="dialog-content" [class.scrollable]="showPreviewControl.value">
    <!-- Email Information -->
    <div class="email-info-section">
      <h3 class="section-title">Email Information</h3>
      <div class="info-grid">
        <div class="info-item">
          <span class="info-label">Recipient:</span>
          <span class="info-value">{{ data.emailLog.recipient }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Email Type:</span>
          <span class="info-value">{{ data.emailLog.emailType }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Original Language:</span>
          <span class="info-value">{{ getOriginalLanguage() }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Sent At:</span>
          <span class="info-value">{{ data.emailLog.sentAt | date:'medium' }}</span>
        </div>
      </div>
    </div>

    <!-- Email Editing Form -->
    <div class="form-section" *ngIf="!isViewMode()">
      <h3 class="section-title">Edit Email Content</h3>

      <!-- Language Selection -->
      <div class="form-row">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Email Language</mat-label>
          <mat-select [formControl]="languageControl">
            <mat-option *ngFor="let lang of availableLanguages" [value]="lang">
              {{ getLanguageDisplayName(lang) }}
            </mat-option>
          </mat-select>
          <mat-icon matSuffix>language</mat-icon>
          <mat-hint>Choose the language for the resent email</mat-hint>
        </mat-form-field>
      </div>

      <!-- Subject -->
      <div class="form-row">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Email Subject</mat-label>
          <input matInput [formControl]="subjectControl" maxlength="200" placeholder="Enter email subject">
          <mat-hint align="end">{{ subjectLength }}/200</mat-hint>
          <mat-error *ngIf="subjectControl.hasError('required')">
            Subject is required
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Template Variables -->
      <div class="variables-section" *ngIf="availableVariables.length > 0">
        <h4 class="variables-title">Available Variables</h4>
        <p class="variables-description">
          Click on a variable to insert it into the email body. Variables will be replaced with actual values when sending.
        </p>
        <div class="variables-grid">
          <button
            *ngFor="let variable of availableVariables"
            (click)="insertVariable(variable)"
            class="variable-button"
            type="button">
            {{ getVariableDisplayName(variable) }}
            <span class="variable-syntax">{{ '{{' + variable + '}}' }}</span>
          </button>
        </div>
      </div>

      <!-- Email Body -->
      <div class="form-row">
        <mat-form-field appearance="outline" class="full-width email-body-field">
          <mat-label>Email Body</mat-label>
          <textarea
            matInput
            [formControl]="bodyControl"
            rows="15"
            maxlength="5000"
            placeholder="Enter email body content. You can use variables like firstName in the text.">
          </textarea>
          <mat-hint align="end">{{ bodyLength }}/5000</mat-hint>
          <mat-error *ngIf="bodyControl.hasError('required')">
            Body is required
          </mat-error>
        </mat-form-field>
      </div>
    </div>

    <!-- Email Preview Toggle & Section -->
    <div class="preview-section" *ngIf="!isViewMode()">
      <div class="preview-toggle">
        <mat-checkbox [formControl]="showPreviewControl" color="primary">
          <span class="toggle-label">Show email preview</span>
        </mat-checkbox>
      </div>

      <div class="preview-container" *ngIf="showPreviewControl.value && body">
        <div class="preview-header">
          <div class="preview-field">
            <strong>To:</strong>
            <span class="preview-value">{{ data.emailLog.recipient }}</span>
          </div>
          <div class="preview-field">
            <strong>Language:</strong>
            <span class="preview-value">{{ getLanguageDisplayName(language) }}</span>
          </div>
        </div>
        <div class="preview-field">
          <strong>Subject:</strong>
          <span class="preview-value">{{ subject || '(No subject)' }}</span>
        </div>
        <div class="preview-body">
          <strong>Body:</strong>
          <div class="preview-content" [innerHTML]="getPreviewBody()"></div>
        </div>
      </div>
    </div>

    <!-- View Mode Message -->
    <div class="view-mode-message" *ngIf="isViewMode()">
      <mat-icon>info</mat-icon>
      <span>This is view mode. To make changes and resend, use the "Resend with Changes" button from the main list.</span>
    </div>
  </div>

  <!-- Actions -->
  <div class="dialog-actions">
    <button mat-stroked-button (click)="close()" type="button">
      <mat-icon>close</mat-icon>
      {{ isViewMode() ? 'Close' : 'Cancel' }}
    </button>
    <button
      *ngIf="!isViewMode()"
      mat-flat-button
      color="primary"
      (click)="resendEmail()"
      [disabled]="!canResend()"
      class="resend-button">
      <mat-icon>send</mat-icon>
      Resend Email
    </button>
  </div>
</div>
