<div class="email-resend-overlay" (click)="close()">
  <div class="email-resend-container" (click)="$event.stopPropagation()">
    <!-- Close Button -->
    <button (click)="close()" class="close-btn" mat-icon-button>
      <mat-icon>close</mat-icon>
    </button>

    <!-- Header -->
    <div class="dialog-header">
      <div class="header-content">
        <mat-icon class="header-icon">email</mat-icon>
        <h2 class="dialog-title">
          {{ isViewMode() ? ('EMAIL_LOGS.VIEW_DETAILS' | translate) : ('EMAIL_LOGS.RESEND_WITH_CHANGES' | translate) }}
        </h2>
      </div>
    </div>

    <!-- Content -->
    <div class="dialog-content" [class.scrollable]="showPreviewControl.value">
      <!-- Email Information -->
      <div class="email-info-section">
        <h3 class="section-title">{{ 'EMAIL_LOGS.EMAIL_INFORMATION' | translate }}</h3>
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">{{ 'EMAIL_LOGS.RECIPIENT' | translate }}:</span>
            <span class="info-value">{{ data.emailLog.recipient }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">{{ 'EMAIL_LOGS.TYPE' | translate }}:</span>
            <span class="info-value">{{ data.emailLog.emailType }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">{{ 'EMAIL_LOGS.ORIGINAL_LANGUAGE' | translate }}:</span>
            <span class="info-value">{{ getOriginalLanguage() }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">{{ 'EMAIL_LOGS.SENT_AT' | translate }}:</span>
            <span class="info-value">{{ data.emailLog.sentAt | date:'medium' }}</span>
          </div>
        </div>
      </div>

      <!-- Email Editing Form -->
      <div class="form-section" *ngIf="!isViewMode()">
        <h3 class="section-title">{{ 'EMAIL_LOGS.EDIT_CONTENT' | translate }}</h3>

        <!-- Language Selection -->
        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>{{ 'EMAIL_LOGS.EMAIL_LANGUAGE' | translate }}</mat-label>
            <mat-select [formControl]="languageControl">
              <mat-option *ngFor="let lang of availableLanguages" [value]="lang">
                {{ getLanguageDisplayName(lang) }}
              </mat-option>
            </mat-select>
            <mat-icon matSuffix>language</mat-icon>
            <mat-hint>{{ 'EMAIL_LOGS.CHOOSE_LANGUAGE_HINT' | translate }}</mat-hint>
          </mat-form-field>
        </div>

        <!-- Subject -->
        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>{{ 'EMAIL_LOGS.EMAIL_SUBJECT' | translate }}</mat-label>
            <input matInput [formControl]="subjectControl" maxlength="200" [placeholder]="'EMAIL_LOGS.SUBJECT_PLACEHOLDER' | translate">
            <mat-hint align="end">{{ subjectLength }}/200</mat-hint>
            <mat-error *ngIf="subjectControl.hasError('required')">
              {{ 'EMAIL_LOGS.SUBJECT_REQUIRED' | translate }}
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Template Variables -->
        <div class="variables-section" *ngIf="availableVariables.length > 0">
          <h4 class="variables-title">{{ 'EMAIL_LOGS.AVAILABLE_VARIABLES' | translate }}</h4>
          <p class="variables-description">
            {{ 'EMAIL_LOGS.VARIABLES_DESCRIPTION' | translate }}
          </p>
          <div class="variables-grid">
            <button
              *ngFor="let variable of availableVariables"
              (click)="insertVariable(variable)"
              class="variable-button"
              type="button">
              {{ getVariableDisplayName(variable) }}
              <span class="variable-syntax">{{ '{{' + variable + '}}' }}</span>
            </button>
          </div>
        </div>

        <!-- Email Body -->
        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width email-body-field">
            <mat-label>{{ 'EMAIL_LOGS.EMAIL_BODY' | translate }}</mat-label>
            <textarea
              matInput
              [formControl]="bodyControl"
              rows="12"
              maxlength="5000"
              [placeholder]="'EMAIL_LOGS.BODY_PLACEHOLDER' | translate">
            </textarea>
            <mat-hint align="end">{{ bodyLength }}/5000</mat-hint>
            <mat-error *ngIf="bodyControl.hasError('required')">
              {{ 'EMAIL_LOGS.BODY_REQUIRED' | translate }}
            </mat-error>
          </mat-form-field>
        </div>
      </div>

      <!-- Email Preview Toggle & Section -->
      <div class="preview-section" *ngIf="!isViewMode()">
        <div class="preview-toggle">
          <mat-checkbox [formControl]="showPreviewControl" color="primary">
            <span class="toggle-label">{{ 'EMAIL_LOGS.SHOW_PREVIEW' | translate }}</span>
          </mat-checkbox>
        </div>

        <div class="preview-container" *ngIf="showPreviewControl.value && body">
          <div class="preview-header">
            <div class="preview-field">
              <strong>{{ 'EMAIL_LOGS.TO' | translate }}:</strong>
              <span class="preview-value">{{ data.emailLog.recipient }}</span>
            </div>
            <div class="preview-field">
              <strong>{{ 'EMAIL_LOGS.LANGUAGE' | translate }}:</strong>
              <span class="preview-value">{{ getLanguageDisplayName(language) }}</span>
            </div>
          </div>
          <div class="preview-field">
            <strong>{{ 'EMAIL_LOGS.SUBJECT' | translate }}:</strong>
            <span class="preview-value">{{ subject || ('EMAIL_LOGS.NO_SUBJECT' | translate) }}</span>
          </div>
          <div class="preview-body">
            <strong>{{ 'EMAIL_LOGS.BODY' | translate }}:</strong>
            <div class="preview-content" [innerHTML]="getPreviewBody()"></div>
          </div>
        </div>
      </div>

      <!-- View Mode Message -->
      <div class="view-mode-message" *ngIf="isViewMode()">
        <mat-icon>info</mat-icon>
        <span>{{ 'EMAIL_LOGS.VIEW_MODE_MESSAGE' | translate }}</span>
      </div>
    </div>

    <!-- Actions -->
    <div class="dialog-actions">
      <button mat-stroked-button (click)="close()" type="button" class="cancel-button">
        <mat-icon>close</mat-icon>
        {{ isViewMode() ? ('COMMON.CLOSE' | translate) : ('COMMON.CANCEL' | translate) }}
      </button>
      <button
        *ngIf="!isViewMode()"
        mat-flat-button
        color="primary"
        (click)="resendEmail()"
        [disabled]="!canResend()"
        class="resend-button">
        <mat-icon>send</mat-icon>
        {{ 'EMAIL_LOGS.RESEND_EMAIL' | translate }}
      </button>
    </div>
  </div>
</div>
