<div class="tags-admin-container">
  <mat-card class="tags-admin-card">
    <div class="tags-admin-header-section">
      <div class="tags-admin-header-content">
        <div class="tags-admin-title-section">
          <h1>{{ 'TAGS.TITLE' | translate }}</h1>
          <p class="tags-admin-subtitle">{{ 'TAGS.ADMIN_SUBTITLE.UPDATE' | translate }}</p>
        </div>
        <button (click)="openDeleteDialog()"
                class="admin-delete-btn"
                mat-flat-button
                type="button"
                color="warn">
          <mat-icon>delete_forever</mat-icon>
          {{ 'COMMON.DELETE' | translate }}
        </button>
      </div>
    </div>

    <form *ngIf="tagForm" (ngSubmit)="onSave()" [formGroup]="tagForm" class="tags-form-one-column-wrapper" id="tagForm">
      <div class="tags-form-content tags-full-width-content">
        <mat-progress-bar *ngIf="saving" class="tags-admin-save-progress" mode="indeterminate"></mat-progress-bar>

        <!-- BASIC INFO -->
        <div class="tags-form-section">
          <h3 class="tags-section-subtitle">
            <mat-icon>info</mat-icon>
            {{ 'TAGS.ADMIN.BASIC_INFO' | translate }}
          </h3>

          <!-- TABS CONTAINER -->
          <mat-error *ngIf="usedLocales.length === 0">
            {{ 'CONFIGURATION.SELECT_DEFAULT_LANGUAGE' | translate }}
          </mat-error>
          <mat-tab-group *ngIf="usedLocales.length > 0" class="tags-locale-tabs">
            <mat-tab *ngFor="let locale of usedLocales" [label]="locale.translatedName">
              <div class="tags-tab-content">
                <div class="tags-form-row">
                  <mat-form-field appearance="outline" class="tags-form-field tags-full-width">
                    <mat-label>{{ 'TAGS.ADMIN.NAME' | translate }}</mat-label>
                    <input matInput
                           [formControlName]="'name_' + locale.languageCode + '_' + locale.regionCode"
                           [placeholder]="'TAGS.ADMIN.NAME_PLACEHOLDER' | translate">
                    <mat-error
                      *ngIf="tagForm.get('name_' + locale.languageCode + '_' + locale.regionCode)?.hasError('required')">
                      {{ 'VALIDATION.REQUIRED' | translate }}
                    </mat-error>
                  </mat-form-field>
                </div>

                <div class="tags-form-row">
                  <mat-form-field appearance="outline" class="tags-form-field tags-full-width">
                    <mat-label>{{ 'TAGS.ADMIN.DESCRIPTION' | translate }}</mat-label>
                    <textarea matInput
                              rows="4"
                              [formControlName]="'description_' + locale.languageCode + '_' + locale.regionCode"
                              [placeholder]="'TAGS.ADMIN.DESCRIPTION_PLACEHOLDER' | translate"></textarea>
                  </mat-form-field>
                </div>

                <div class="tags-form-row">
                  <mat-form-field appearance="outline" class="tags-form-field tags-full-width">
                    <mat-label>{{ 'TAGS.URL' | translate }}</mat-label>
                    <input matInput
                           [formControlName]="'url_' + locale.languageCode + '_' + locale.regionCode"
                           [placeholder]="'TAGS.URL_PLACEHOLDER' | translate">
                    <mat-error
                      *ngIf="tagForm.get('url_' + locale.languageCode + '_' + locale.regionCode)?.hasError('required')">
                      {{ 'VALIDATION.REQUIRED' | translate }}
                    </mat-error>
                  </mat-form-field>
                </div>
              </div>
            </mat-tab>
          </mat-tab-group>

          <div class="tags-form-row">
            <mat-form-field appearance="outline" class="tags-form-field">
              <mat-label>{{ 'TAGS.PRIORITY' | translate }}</mat-label>
              <input formControlName="priority" matInput type="number"
                     [placeholder]="'TAGS.PRIORITY_PLACEHOLDER' | translate" required>
              <mat-error *ngIf="tagForm.get('priority')?.hasError('required')">
                {{ 'VALIDATION.REQUIRED' | translate }}
              </mat-error>
              <mat-error *ngIf="tagForm.get('priority')?.hasError('min')">
                {{ 'VALIDATION.MIN' | translate }}: 0
              </mat-error>
            </mat-form-field>

            <div class="tags-checkbox-group">
              <mat-checkbox class="tags-admin-active-checkbox-wrapper" formControlName="active">
                {{ 'TAGS.ACTIVE' | translate }}
              </mat-checkbox>
            </div>
          </div>

          <!-- VISUAL PROPERTIES -->
          <div class="tags-visual-properties-section">
            <div class="tags-form-row">
              <!-- Color Picker -->
              <div class="tags-color-picker-field">
                <label class="tags-field-label">{{ 'TAGS.COLOR' | translate }}</label>
                <div class="tags-color-picker-container">
                  <label class="tags-color-picker-wrapper">
                    <div class="tags-color-preview" [style.background]="tagForm.get('color')?.value || '#3498db'">
                      <mat-icon class="tags-color-preview-icon">palette</mat-icon>
                    </div>
                    <input type="color"
                           formControlName="color"
                           class="tags-color-input"
                           [value]="tagForm.get('color')?.value || '#3498db'"
                           (input)="onColorChange($event)">
                  </label>
                  <span class="tags-color-value">{{ tagForm.get('color')?.value || '#3498db' }}</span>
                </div>
              </div>

              <!-- Icon Selector -->
              <div class="tags-icon-selector-field">
                <label class="tags-field-label">{{ 'TAGS.ICON' | translate }}</label>
                <div class="tags-icon-selector-container">
                  <button type="button"
                          class="tags-icon-selector-trigger"
                          (click)="openIconSelector()"
                          [class.tags-has-icon]="tagForm.get('icon')?.value">
                    <span *ngIf="tagForm.get('icon')?.value" class="selected-icon-content">
                      <mat-icon *ngIf="!isEmoji(tagForm.get('icon')?.value)" class="tags-selected-icon">
                        {{ tagForm.get('icon')?.value }}
                      </mat-icon>
                      <span *ngIf="isEmoji(tagForm.get('icon')?.value)" class="selected-emoji">
                        {{ tagForm.get('icon')?.value }}
                      </span>
                    </span>
                    <span *ngIf="!tagForm.get('icon')?.value" class="tags-icon-placeholder">
                      {{ 'TAGS.SELECT_ICON' | translate }}
                    </span>
                    <mat-icon class="tags-dropdown-icon">arrow_drop_down</mat-icon>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- RELATIONS -->
        <div class="tags-form-section">
          <h3 class="tags-section-subtitle">
            <mat-icon>category</mat-icon>
            {{ 'TAGS.ADMIN.RELATIONS' | translate }}
          </h3>

          <div class="tags-form-row">
            <mat-form-field appearance="outline" class="tags-form-field tags-full-width">
              <mat-label>{{ 'TAGS.ADMIN.CATEGORIES' | translate }}</mat-label>
              <mat-select formControlName="categoryIds" multiple>
                <mat-option *ngFor="let cat of allCategories" [value]="cat.id">
                  {{ cat.translatedName }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <div class="tags-form-row">
            <mat-form-field appearance="outline" class="tags-form-field tags-full-width">
              <mat-label>{{ 'TAGS.ADMIN.PRODUCTS' | translate }}</mat-label>
              <mat-select formControlName="productIds" multiple>
                <mat-option *ngFor="let prod of allProducts" [value]="prod.id">
                  {{ prod.translatedName }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <div class="tags-form-row">
            <mat-form-field appearance="outline" class="tags-form-field tags-full-width">
              <mat-label>{{ 'TAGS.ADMIN.MIXTURES' | translate }}</mat-label>
              <mat-select formControlName="mixtureIds" multiple>
                <mat-option *ngFor="let mix of allMixtures" [value]="mix.id">
                  {{ mix.translatedName }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        </div>
      </div>
    </form>

    <!-- FLOATING ACTION BAR -->
    <div class="tags-admin-actions-bar">
      <div class="tags-admin-action-buttons">
        <button (click)="openCancelDialog()"
                color="warn"
                mat-stroked-button
                type="button"
                class="tags-cancel-btn">
          <mat-icon>close</mat-icon>
          {{ 'COMMON.CANCEL' | translate }}
        </button>
        <button [disabled]="!tagForm || tagForm.invalid || saving || !tagForm.dirty"
                color="primary"
                form="tagForm"
                mat-flat-button
                type="submit"
                class="tags-save-btn">
          <mat-icon>save</mat-icon>
          {{ saving ? ('COMMON.SAVING' | translate) : ('COMMON.SAVE' | translate) }}
        </button>
      </div>
    </div>
  </mat-card>
</div>

<!-- Icon Selector Modal -->
<div *ngIf="showIconSelector" class="tags-icon-selector-modal" [class.tags-show]="showIconSelector">
  <div class="tags-modal-backdrop" (click)="closeIconSelector()"></div>
  <div class="tags-modal-content">
    <div class="tags-modal-header">
      <h3>{{ 'TAGS.SELECT_ICON' | translate }}</h3>
      <button class="tags-close-btn" (click)="closeIconSelector()">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="tags-search-section">
      <mat-form-field appearance="outline" class="tags-search-field">
        <mat-label>{{ 'TAGS.SEARCH_ICONS' | translate }}</mat-label>
        <input matInput
               [(ngModel)]="iconSearchTerm"
               (ngModelChange)="onIconSearchChange()"
               [placeholder]="'TAGS.SEARCH_ICONS_PLACEHOLDER' | translate">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>
    </div>

    <div class="tags-modal-body">
      <mat-tab-group (selectedTabChange)="onIconTabChange($event.index)" class="tags-icon-type-tabs">
        <mat-tab label="Material Icons">
          <div class="tags-icons-grid-container">
            <div class="tags-icons-grid">
              <div *ngFor="let icon of filteredIcons"
                   class="tags-icon-item"
                   [class.tags-selected]="selectedIcon === icon"
                   (click)="selectIcon(icon)">
                <mat-icon class="tags-icon-display">{{ icon }}</mat-icon>
                <span class="tags-icon-name">{{ icon }}</span>
              </div>
            </div>
          </div>
        </mat-tab>
        <mat-tab label="Emojis">
          <div class="tags-icons-grid-container">
            <div class="tags-icons-grid tags-emoji-grid">
              <div *ngFor="let emoji of filteredEmojis"
                   class="tags-icon-item tags-emoji-item"
                   [class.tags-selected]="selectedIcon === emoji.emoji"
                   (click)="selectIcon(emoji)">
                <span class="tags-emoji-display">{{ emoji.emoji }}</span>
                <span class="tags-icon-name">{{ emoji.description }}</span>
              </div>
            </div>
          </div>
        </mat-tab>
      </mat-tab-group>
    </div>

    <!-- MODAL ACTIONS -->
    <div class="tags-modal-actions">
      <button mat-stroked-button (click)="closeIconSelector()" class="tags-cancel-icon-btn">
        {{ 'COMMON.CANCEL' | translate }}
      </button>
      <button mat-flat-button color="primary" (click)="confirmIconSelection()" class="tags-confirm-icon-btn">
        {{ 'COMMON.SELECT' | translate }}
      </button>
    </div>
  </div>
</div>
