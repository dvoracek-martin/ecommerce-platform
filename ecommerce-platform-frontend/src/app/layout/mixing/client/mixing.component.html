<div class="app-container">
  <div class="mixing-container" #mixingContainer>

    <!-- Sticky Header with Categories -->
    <div class="sticky-header-mixing">
      <h1>{{ 'MIXING.TITLE' | translate }}</h1>
      <div class="category-nav-wrapper">
        <button class="carousel-btn left" (click)="prevCategory()" [disabled]="activeCategoryIndex === 0">‹</button>
        <div class="category-nav-row">
          <div *ngFor="let category of categories; let i = index"
               class="category-nav-item"
               [class.active]="i === activeCategoryIndex"
               (click)="jumpToCategoryAndScroll(i)">
            <ng-container *ngIf="category.media?.[0]?.contentType?.startsWith('image/'); else categoryPlaceholder">
              <img [src]="'data:' + category.media[0].contentType + ';base64,' + category.media[0].base64Data"
                   alt="{{ category.translatedName }}"
                   class="category-image"/>
            </ng-container>
            <ng-template #categoryPlaceholder>
              <div class="category-placeholder">{{ category.translatedName }}</div>
            </ng-template>
            <div class="category-name">{{ category.translatedName }}</div>
          </div>
        </div>
        <button class="carousel-btn right" (click)="nextCategory()"
                [disabled]="activeCategoryIndex === categories.length - 1">›
        </button>
      </div>
    </div>

    <div *ngIf="isLoading" class="loading-section">
      <mat-progress-bar mode="indeterminate"></mat-progress-bar>
      <div class="loading-text">Loading products...</div>
    </div>

    <div *ngIf="error" class="error-section">
      <mat-icon color="warn" class="error-icon">error_outline</mat-icon>
      <div class="error-text">{{ error }}</div>
      <button mat-stroked-button color="warn" (click)="navigateHome()">
        <mat-icon>arrow_back</mat-icon>
        Back to the main page
      </button>
    </div>


    <!-- Products Carousel -->
    <div class="main-content-wrapper" *ngIf="!isLoading && !error">
      <div class="products-carousel-wrapper">
        <div class="products-carousel-container">
          <div class="products-carousel-inner" [style.transform]="'translateX(-' + activeCategoryIndex * 100 + '%)'">
            <div *ngFor="let category of categories" class="category-section">
              <h2 class="category-title">{{ category.translatedName }}</h2>
              <div class="products-row">
                <div *ngFor="let product of productsByCategory[category.id]; trackBy: trackById"
                     class="product-card"
                     [id]="'product-card-' + product.id">
                  <ng-container *ngIf="product.media?.length; else noMedia">
                    <img *ngIf="product.media[0].contentType?.startsWith('image/')"
                         [src]="'data:' + product.media[0].contentType + ';base64,' + product.media[0].base64Data"
                         alt="{{ product.media[0].objectKey }}"
                         class="product-image"/>
                    <video *ngIf="product.media[0].contentType?.startsWith('video/')"
                           class="product-image"
                           muted autoplay loop preload="metadata" playsinline>
                      <source [src]="'data:' + product.media[0].contentType + ';base64,' + product.media[0].base64Data"
                              [type]="product.media[0].contentType"/>
                    </video>
                  </ng-container>
                  <ng-template #noMedia>
                    <div class="no-media">{{ 'PRODUCTS.NO_MEDIA' | translate }}</div>
                  </ng-template>

                  <div class="product-name">{{ product.translatedName }}</div>
                  <div class="product-description">{{ product.translatedDescription }}</div>
                  <div class="product-bottom">
                    <div class="product-info-btn" (click)="showProductInfo(product)">
                      <mat-icon>info</mat-icon>
                    </div>
                    <div class="product-price">{{ product.price | currency }}</div>
                    <button class="add-mixture-btn"
                            [disabled]="isAddButtonDisabled(product) || addingProductId === product.id"
                            [title]="getAddButtonTooltip(product)"
                            (click)="addProductToMixture(product)">
                      <ng-container *ngIf="addingProductId === product.id; else defaultAdd">
                        <div class="adding-animation">
                          <span class="icon-pulse">✔</span>
                        </div>
                      </ng-container>
                      <ng-template #defaultAdd>
                        <ng-container *ngIf="!isAddButtonDisabled(product)">{{ 'PRODUCTS.ADD' | translate }}
                        </ng-container>
                        <ng-container *ngIf="isAddButtonDisabled(product)">{{ 'PRODUCTS.GRID_FULL' | translate }}
                        </ng-container>
                      </ng-template>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mixture Grid -->
  <div class="mixture-container">
    <div class="mixture-name-container">
      <h2 *ngIf="!isEditingName" (click)="editName()">{{ mixtureName }}</h2>
      <input *ngIf="isEditingName"
             #nameInput
             type="text"
             [(ngModel)]="mixtureName"
             (blur)="saveName()"
             (keyup.enter)="saveName()"
             class="editable-name"
             placeholder="Enter mixture name"/>
      <button *ngIf="!isEditingName" class="btn-edit" (click)="editName()">
        <mat-icon>edit</mat-icon>
      </button>
    </div>

    <!-- Warning message for default name -->
    <div *ngIf="isDefaultName()" class="name-warning">
      <span>Please name your mixture</span>
    </div>

    <div class="mixture-grid">
      <ng-container *ngFor="let product of mixedProducts; let index = index; trackBy: trackByMixtureIndex">
        <div class="mixed-product-card"
             [ngClass]="{'premium-card': index === 4}"
             [id]="'mixed-card-' + index">
          <ng-container *ngIf="product as p">
            <img *ngIf="p.media?.[0]?.contentType?.startsWith('image/')"
                 [src]="'data:' + p.media[0].contentType + ';base64,' + p.media[0].base64Data"
                 class="mixed-product-image"
                 alt="{{ p.translatedName }}"/>
            <div class="mixed-product-name">{{ p.translatedName }}</div>
            <button class="btn-remove" (click)="removeProductFromMixture(index)">x</button>
          </ng-container>
          <div *ngIf="!product" class="empty-grid-cell">
            <div class="empty-cell-text">
              <span class="icon-plus">+</span>
              Add Product
            </div>
          </div>
        </div>
      </ng-container>
    </div>

    <!-- Mixture Summary -->
    <div class="mixture-summary">
      <h3>Summary</h3>
      <ng-container *ngFor="let item of getProductsByCategoryInMixture() | keyvalue">
        <h4 class="category-heading">{{ item.key }}</h4>
        <ul>
          <li *ngFor="let summary of item.value; trackBy: trackBySummaryProductId">
            <span class="product-count">{{ summary.count }}x</span>
            {{ summary.product.translatedName }}
            <span class="product-price-summary">{{ summary.totalPrice | currency }}</span>
          </li>
        </ul>
      </ng-container>
      <div class="final-price">
        Total: {{ calculateTotalPrice() | currency }}
      </div>
      <div class="mixture-actions">
        <span
          matTooltip="{{ isDefaultName() ? ('MIXTURE.NAME_REQUIRED' | translate) : '' }}"
          [matTooltipDisabled]="!isDefaultName()" matTooltipShowDelay="200"
          class="tooltip-wrapper">
          <button class="btn add-to-cart-btn"
                  [disabled]="isDefaultName() || getNonNullMixedProductsCount() === 0"
                  (click)="addMixtureToCart()">
            {{ 'MIXTURE.ADD_TO_CART' | translate }}
          </button>
        </span>
      </div>
    </div>
  </div>

  <!-- Product Info Popup -->
  <div *ngIf="showInfoPopup" class="popup-overlay" (click)="closePopup()">
    <div class="popup-content" (click)="$event.stopPropagation()">
      <button class="popup-close-btn" (click)="closePopup()">
        <mat-icon>close</mat-icon>
      </button>
      <div *ngIf="selectedProduct" class="popup-flex-container">
        <div class="popup-media-container">
          <ng-container *ngIf="selectedProduct.media?.length; else noMediaPopup">
            <img *ngIf="selectedProduct.media[0].contentType?.startsWith('image/')"
                 [src]="'data:' + selectedProduct.media[0].contentType + ';base64,' + selectedProduct.media[0].base64Data"
                 class="popup-image"
                 alt="{{ selectedProduct.media[0].objectKey }}"/>
            <video *ngIf="selectedProduct.media[0].contentType?.startsWith('video/')"
                   class="popup-image"
                   muted autoplay loop playsinline>
              <source
                [src]="'data:' + selectedProduct.media[0].contentType + ';base64,' + selectedProduct.media[0].base64Data"
                [type]="selectedProduct.media[0].contentType"/>
            </video>
          </ng-container>
          <ng-template #noMediaPopup>
            <div class="no-media-popup">{{ 'PRODUCTS.NO_MEDIA' | translate }}</div>
          </ng-template>
        </div>

        <div class="popup-scroll-content">
          <div class="popup-details">
            <h2 class="popup-product-name">{{ selectedProduct.translatedName }}</h2>
            <div class="popup-price">{{ selectedProduct.price | currency }}</div>

            <div class="popup-info-grid">
              <div *ngIf="selectedProduct.translatedDescription" class="info-item">
                <span class="info-label">Description:</span>
                <p>{{ selectedProduct.translatedDescription }}</p>
              </div>
              <div *ngIf="selectedProduct.responseTagDTOS?.length" class="info-item">
                <span class="info-label">Tags:</span>
                <div class="tags-container">
                  <span *ngFor="let tag of selectedProduct.responseTagDTOS" class="tag">{{ tag.translatedName }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div *ngIf="isAddingToCart" class="mixture-loading-overlay">
    <div class="mixture-loading-content">
      <div class="spinner-container">
        <mat-spinner diameter="60"></mat-spinner>
      </div>
      <h3>{{ 'MIXTURE.ADDING_TO_CART' | translate }}</h3>
      <p>{{ 'MIXTURE.PLEASE_WAIT' | translate }}</p>
    </div>
  </div>
</div>
