<div class="order-container">
  <div class="order-header">
    <div class="admin-title-section">
      <h1>{{ 'CUSTOMER.TITLE' | translate }}</h1>
      <div class="order-date">
        {{ 'CUSTOMER.ID' | translate }}: {{ (customer.id) }}
      </div>
    </div>

    <div class="admin-status-section">

    </div>
  </div>

  <div class="order-layout-wrapper">
    <div class="order-main-content-wrapper">
      <div class="order-content">
        <!-- Customer Form -->
        <div class="order-items-section">
          <form id="customerForm" (ngSubmit)="onSave()" [formGroup]="customerForm" class="form-one-column-wrapper" id="customerForm">
            <div class="form-content">
              <mat-progress-bar *ngIf="saving || savingPassword" class="admin-save-progress"
                                mode="indeterminate"></mat-progress-bar>

              <!-- Basic Info -->
              <div class="form-section">
                <h3 class="section-subtitle">
                  <mat-icon>badge</mat-icon>
                  {{ 'CUSTOMER.BASIC_INFO' | translate }}
                </h3>
                <div class="form-row">
                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>{{ 'CUSTOMER.EMAIL' | translate }}</mat-label>
                    <input formControlName="email" matInput required>
                    <mat-error *ngIf="customerForm.get('email')?.hasError('required')">
                      {{ 'USER_REGISTRATION.EMAIL_REQUIRED' | translate }}
                    </mat-error>
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>{{ 'CUSTOMER.FIRST_NAME' | translate }}</mat-label>
                    <input formControlName="firstName" matInput required>
                    <mat-error *ngIf="customerForm.get('firstName')?.hasError('required')">
                      {{ 'USER_REGISTRATION.FIRST_NAME_REQUIRED' | translate }}
                    </mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>{{ 'CUSTOMER.LAST_NAME' | translate }}</mat-label>
                    <input formControlName="lastName" matInput required>
                    <mat-error *ngIf="customerForm.get('lastName')?.hasError('required')">
                      {{ 'USER_REGISTRATION.LAST_NAME_REQUIRED' | translate }}
                    </mat-error>
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>{{ 'CUSTOMER.PREFERRED_LANGUAGE' | translate }}</mat-label>
                    <mat-select formControlName="preferredLanguage" (selectionChange)="onLanguageChange($event.value)">
                      <mat-option *ngFor="let lang of languages" [value]="lang.code">
                        <mat-icon class="flag-icon" *ngIf="lang.icon" [svgIcon]="lang.icon"></mat-icon>
                        {{ lang.name }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>
              </div>

              <!-- Shipping Address -->
              <div class="form-section" formGroupName="address">
                <h3 class="section-subtitle">
                  <mat-icon>location_on</mat-icon>
                  {{ 'CUSTOMER.SHIPPING_ADDRESS' | translate }}
                </h3>

                <div class="form-row">
                  <mat-form-field appearance="outline" class="form-field full-width">
                    <mat-label>{{ 'CUSTOMER.PHONE' | translate }}</mat-label>
                    <input formControlName="phone" matInput>
                    <mat-error *ngIf="customerForm.get(['address', 'phone'])?.hasError('pattern')">
                      {{ 'CUSTOMER.PHONE_INVALID' | translate }}
                    </mat-error>
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>{{ 'CUSTOMER.STREET' | translate }}</mat-label>
                    <input formControlName="street" matInput required>
                    <mat-error *ngIf="customerForm.get(['address', 'street'])?.hasError('required')">
                      {{ 'CUSTOMER.STREET_REQUIRED' | translate }}
                    </mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>{{ 'CUSTOMER.HOUSE_NUMBER' | translate }}</mat-label>
                    <input formControlName="houseNumber" matInput required>
                    <mat-error *ngIf="customerForm.get(['address', 'houseNumber'])?.hasError('required')">
                      {{ 'CUSTOMER.HOUSE_NUMBER_REQUIRED' | translate }}
                    </mat-error>
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>{{ 'CUSTOMER.CITY' | translate }}</mat-label>
                    <input formControlName="city" matInput required>
                    <mat-error *ngIf="customerForm.get(['address', 'city'])?.hasError('required')">
                      {{ 'CUSTOMER.CITY_REQUIRED' | translate }}
                    </mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>{{ 'CUSTOMER.ZIP_CODE' | translate }}</mat-label>
                    <input formControlName="zipCode" matInput required>
                    <mat-error *ngIf="customerForm.get(['address', 'zipCode'])?.hasError('required')">
                      {{ 'CUSTOMER.ZIP_CODE_REQUIRED' | translate }}
                    </mat-error>
                    <mat-error *ngIf="customerForm.get(['address', 'zipCode'])?.hasError('pattern')">
                      {{ 'CUSTOMER.ZIP_CODE_NUMBERS_ONLY' | translate }}
                    </mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>{{ 'CUSTOMER.COUNTRY' | translate }}</mat-label>
                    <mat-select formControlName="country" required>
                      <mat-option value="Switzerland">Switzerland</mat-option>
                    </mat-select>
                    <mat-error *ngIf="customerForm.get(['address', 'country'])?.hasError('required')">
                      {{ 'CUSTOMER.COUNTRY_REQUIRED' | translate }}
                    </mat-error>
                  </mat-form-field>
                </div>
              </div>

              <!-- Active & Billing -->
              <div class="form-field form-section">
                <mat-checkbox class="admin-active-checkbox-wrapper" formControlName="active">
                  {{ 'PRODUCTS.ACTIVE' | translate }}
                </mat-checkbox>
              </div>

              <div class="form-section">
                <mat-checkbox formControlName="sameBillingAddress">
                  {{ 'CUSTOMER.SAME_BILLING_ADDRESS' | translate }}
                </mat-checkbox>
              </div>

              <!-- Billing Address -->
              <div *ngIf="showBillingAddress" @slideDown class="form-section" formGroupName="billingAddress">
                <h3 class="section-subtitle">
                  <mat-icon>business</mat-icon>
                  {{ 'CUSTOMER.BILLING_ADDRESS' | translate }}
                </h3>

                <div class="form-row">
                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>{{ 'CUSTOMER.FIRST_NAME' | translate }}</mat-label>
                    <input formControlName="firstName" matInput required>
                    <mat-error *ngIf="customerForm.get(['billingAddress', 'firstName'])?.hasError('required')">
                      {{ 'USER_REGISTRATION.FIRST_NAME_REQUIRED' | translate }}
                    </mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>{{ 'CUSTOMER.LAST_NAME' | translate }}</mat-label>
                    <input formControlName="lastName" matInput required>
                    <mat-error *ngIf="customerForm.get(['billingAddress', 'lastName'])?.hasError('required')">
                      {{ 'USER_REGISTRATION.LAST_NAME_REQUIRED' | translate }}
                    </mat-error>
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <mat-form-field appearance="outline" class="form-field full-width">
                    <mat-label>{{ 'CUSTOMER.PHONE' | translate }}</mat-label>
                    <input formControlName="phone" matInput>
                    <mat-error *ngIf="customerForm.get(['billingAddress', 'phone'])?.hasError('pattern')">
                      {{ 'CUSTOMER.PHONE_INVALID' | translate }}
                    </mat-error>
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>{{ 'CUSTOMER.STREET' | translate }}</mat-label>
                    <input formControlName="street" matInput required>
                    <mat-error *ngIf="customerForm.get(['billingAddress', 'street'])?.hasError('required')">
                      {{ 'CUSTOMER.STREET_REQUIRED' | translate }}
                    </mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>{{ 'CUSTOMER.HOUSE_NUMBER' | translate }}</mat-label>
                    <input formControlName="houseNumber" matInput required>
                    <mat-error *ngIf="customerForm.get(['billingAddress', 'houseNumber'])?.hasError('required')">
                      {{ 'CUSTOMER.HOUSE_NUMBER_REQUIRED' | translate }}
                    </mat-error>
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>{{ 'CUSTOMER.CITY' | translate }}</mat-label>
                    <input formControlName="city" matInput required>
                    <mat-error *ngIf="customerForm.get(['billingAddress', 'city'])?.hasError('required')">
                      {{ 'CUSTOMER.CITY_REQUIRED' | translate }}
                    </mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>{{ 'CUSTOMER.ZIP_CODE' | translate }}</mat-label>
                    <input formControlName="zipCode" matInput required>
                    <mat-error *ngIf="customerForm.get(['billingAddress', 'zipCode'])?.hasError('required')">
                      {{ 'CUSTOMER.ZIP_CODE_REQUIRED' | translate }}
                    </mat-error>
                    <mat-error *ngIf="customerForm.get(['billingAddress', 'zipCode'])?.hasError('pattern')">
                      {{ 'CUSTOMER.ZIP_CODE_NUMBERS_ONLY' | translate }}
                    </mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>{{ 'CUSTOMER.COUNTRY' | translate }}</mat-label>
                    <mat-select formControlName="country" required>
                      <mat-option value="Switzerland">Switzerland</mat-option>
                    </mat-select>
                    <mat-error *ngIf="customerForm.get(['billingAddress', 'country'])?.hasError('required')">
                      {{ 'CUSTOMER.COUNTRY_REQUIRED' | translate }}
                    </mat-error>
                  </mat-form-field>
                </div>
              </div>

            </div>
          </form>

          <!-- Password Form -->
          <form #passwordFormDirective="ngForm" (ngSubmit)="onChangePassword(passwordFormDirective)"
                [formGroup]="passwordForm" class="form-one-column-wrapper">
            <div class="form-content">
              <div class="form-section">
                <h3 class="section-subtitle">
                  <mat-icon>lock</mat-icon>
                  {{ 'CUSTOMER.CHANGE_PASSWORD' | translate }}
                </h3>
                <div formGroupName="passwordChange">
                  <div class="form-row">
                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>{{ 'CUSTOMER.NEW_PASSWORD' | translate }}</mat-label>
                      <input formControlName="newPassword" matInput type="password">
                      <mat-error *ngIf="passwordForm.get(['passwordChange', 'newPassword'])?.hasError('required')">
                        {{ 'USER_REGISTRATION.PASSWORD_REQUIRED' | translate }}
                      </mat-error>
                      <mat-error *ngIf="passwordForm.get(['passwordChange', 'newPassword'])?.hasError('minlength')">
                        {{ 'USER_REGISTRATION.PASSWORD_MINLENGTH' | translate }}
                      </mat-error>
                      <mat-error *ngIf="passwordForm.get(['passwordChange', 'newPassword'])?.hasError('pattern')">
                        {{ 'USER_REGISTRATION.PASSWORD_PATTERN' | translate }}
                      </mat-error>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="form-field">
                      <mat-label>{{ 'CUSTOMER.CONFIRM_NEW_PASSWORD' | translate }}</mat-label>
                      <input formControlName="confirmNewPassword" matInput type="password">
                      <mat-error
                        *ngIf="passwordForm.get(['passwordChange', 'confirmNewPassword'])?.hasError('required')">
                        {{ 'USER_REGISTRATION.PASSWORD_REQUIRED' | translate }}
                      </mat-error>
                      <mat-error
                        *ngIf="passwordForm.get('passwordChange')?.hasError('mismatch') &&
                               (passwordForm.get(['passwordChange', 'confirmNewPassword'])?.dirty ||
                                passwordForm.get(['passwordChange', 'confirmNewPassword'])?.touched)">
                        {{ 'USER_REGISTRATION.PASSWORDS_MISMATCH' | translate }}
                      </mat-error>
                    </mat-form-field>
                  </div>
                </div>
              </div>
            </div>
          </form>

        </div>
        <!-- Order Info Section -->
        <div class="order-info-section">
          <h2>{{ 'ORDERS.TITLE' | translate }}</h2>
          <p class="admin-subtitle">{{ 'ORDERS.CLIENT_SUBTITLE' | translate }}</p>

          <div *ngIf="isOrdersLoading" class="loading-section">
            <mat-progress-bar mode="indeterminate"></mat-progress-bar>
            <div class="loading-text">{{ 'ORDERS.LOADING' | translate }}</div>
          </div>

          <div *ngIf="ordersError" class="error-section">
            <mat-icon color="warn" class="error-icon">error_outline</mat-icon>
            <div class="error-text">{{ ordersError }}</div>
          </div>

          <div *ngIf="!isOrdersLoading && !ordersError && ordersDataSource.data.length === 0" class="no-orders-section">
            <mat-icon class="no-orders-icon">history</mat-icon>
            <p class="no-orders-message">{{ 'ORDERS.NO_ORDERS' | translate }}</p>
          </div>

          <!-- Table -->
          <div class="table-section" *ngIf="!isOrdersLoading && !ordersError && ordersDataSource.data.length > 0">
            <div class="mat-elevation-z8 table-container">
              <table mat-table [dataSource]="ordersDataSource" matSort class="wide-table">

                <!-- Invoice ID -->
                <ng-container matColumnDef="invoiceId">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header> {{ 'ORDERS.INVOICE_ID' | translate }}</th>
                  <td mat-cell *matCellDef="let order"> {{ order.invoiceId }}</td>
                </ng-container>

                <!-- Order Date -->
                <ng-container matColumnDef="orderDate">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header> {{ 'ORDERS.DATE' | translate }}</th>
                  <td mat-cell *matCellDef="let order"> {{ order.orderDate | date:'medium' }}</td>
                </ng-container>

                <!-- Shipping Method -->
                <ng-container matColumnDef="shippingMethod">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header> {{ 'ORDERS.SHIPPING_METHOD' | translate }}</th>
                  <td mat-cell *matCellDef="let order"> {{ order.shippingMethod }}</td>
                </ng-container>

                <!-- Payment Method -->
                <ng-container matColumnDef="paymentMethod">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header> {{ 'ORDERS.PAYMENT_METHOD' | translate }}</th>
                  <td mat-cell *matCellDef="let order"> {{ order.paymentMethod }}</td>
                </ng-container>

                <!-- Final Total -->
                <ng-container matColumnDef="finalTotal">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header> {{ 'ORDERS.TOTAL' | translate }}</th>
                  <td mat-cell *matCellDef="let order"> {{ order.finalTotal | currency }}</td>
                </ng-container>

                <!-- Status -->
                <ng-container matColumnDef="status">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header> {{ 'ORDERS.STATUS' | translate }}</th>
                  <td mat-cell *matCellDef="let order">
                    <span class="status-badge" [ngClass]="getOrderStatusClass(order.status)">
                      {{ getOrderStatusText(order.status) }}
                    </span>
                  </td>
                </ng-container>

                <!-- Actions -->
                <ng-container matColumnDef="actions">
                  <th mat-header-cell *matHeaderCellDef class="actions-header"> {{ 'ORDERS.ACTIONS' | translate }}</th>
                  <td mat-cell *matCellDef="let order" class="actions-cell">
                    <div class="admin-action-buttons">
                      <button mat-icon-button (click)="viewOrderDetails(order.id)" matTooltip="View Details"
                              class="action-btn view-btn">
                        <mat-icon>visibility</mat-icon>
                      </button>
                      <button mat-icon-button (click)="downloadOrderInvoice(order)" matTooltip="Download Invoice"
                              class="action-btn download-btn">
                        <mat-icon>download</mat-icon>
                      </button>
                    </div>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="ordersDisplayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: ordersDisplayedColumns;"></tr>
              </table>

              <mat-paginator
                [pageSizeOptions]="[5, 10, 20]"
                showFirstLastButtons
                pageSize="5"
                [length]="ordersDataSource.filteredData.length">
              </mat-paginator>
            </div>
          </div>
        </div>
      </div>
    </div>


    <div class="order-summary">
      <div class="summary-card">
        <h3>{{ 'ORDER_DETAIL.ORDER_SUMMARY' | translate }}</h3>
      </div>

      <div class="admin-action-buttons">
        <button type="submit" form="customerForm" color="primary" mat-flat-button
        [disabled]="!customerForm.dirty || customerForm.invalid || saving">
          <mat-icon>save</mat-icon>
          {{ 'ORDER_DETAIL.SAVE_CHANGES' | translate }}
        </button>
      </div>
      <div class="form-row action-row">
        <button
          (click)="onChangePassword(passwordFormDirective)"
          [disabled]="passwordForm.get('passwordChange')?.invalid || !passwordForm.get('passwordChange')?.dirty || savingPassword"
          color="primary" mat-flat-button type="button">
          <mat-icon>lock_open</mat-icon>
          {{ savingPassword ? ('COMMON.SAVING' | translate) : ('COMMON.CHANGE_PASSWORD' | translate) }}
        </button>
      </div>

      <!-- Back to Orders Button -->
      <div class="back-button-container">
        <button (click)="navigateBackToList()" class="navigate-back-btn" mat-stroked-button>
          <mat-icon>arrow_back</mat-icon>
          Back to Customers
        </button>
      </div>
    </div>
  </div>
</div>
