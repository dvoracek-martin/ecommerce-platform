<div class="admin-container">
  <mat-card class="admin-card">
    <!-- Header Section -->
    <div class="admin-header-section">
      <div class="admin-header-content">
        <div class="admin-title-section">
          <h1>{{ 'CART.TITLE' | translate }}</h1>
          <p class="admin-subtitle" *ngIf="isCartLoaded && cartItemsWithDetails.length > 0">
            {{ cartItemsWithDetails.length }} {{ 'CART.ITEMS' | translate }}
          </p>
          <p class="admin-subtitle" *ngIf="isCartLoaded && cartItemsWithDetails.length === 0">
            {{ 'CART.EMPTY_DESCRIPTION' | translate }}
          </p>
        </div>

        <div class="admin-status-section" *ngIf="isCartLoaded && cartItemsWithDetails.length > 0">
          <div class="admin-totals">
            <div class="total-label">{{ 'CART.TOTAL' | translate }}</div>
            <div class="total-amount">{{ getDiscountedTotal() | swissCurrency }}</div>
          </div>
        </div>
      </div>
    </div>

    <div class="order-layout-wrapper">
      <!-- Main Content -->
      <div class="order-main-content-wrapper">
        <!-- Loading State -->
        <div *ngIf="isLoading" class="admin-loading-section">
          <mat-progress-bar mode="indeterminate"></mat-progress-bar>
          <div class="admin-loading-text">{{ 'CART.LOADING' | translate }}</div>
        </div>

        <!-- Empty Cart State -->
        <div *ngIf="isCartLoaded && cartItemsWithDetails.length === 0" class="admin-empty-state">
          <mat-icon class="empty-icon">shopping_basket</mat-icon>
          <h3>{{ 'CART.EMPTY' | translate }}</h3>
          <p>{{ 'CART.EMPTY_DESCRIPTION' | translate }}</p>
          <button class="admin-create-btn" mat-flat-button routerLink="/products">
            <mat-icon>store</mat-icon>
            {{ 'CART.SHOP_NOW' | translate }}
          </button>
        </div>

        <!-- Cart Items -->
        <div *ngIf="isCartLoaded && cartItemsWithDetails.length > 0" class="order-content">
          <div class="form-section">
            <h3 class="section-subtitle">
              <mat-icon>shopping_cart</mat-icon>
              {{ 'CART.ITEMS' | translate }} ({{ cartItemsWithDetails.length }})
            </h3>

            <div class="order-items">
              <div *ngFor="let item of cartItemsWithDetails; trackBy: trackByItemId"
                   class="order-item"
                   [class.mixture-item]="item.cartItemType === CartItemType.MIXTURE"
                   [class.updating]="item.updating">

                <!-- Item Media -->
                <div class="item-media"
                     (click)="item.cartItemType === CartItemType.PRODUCT ? goToProduct(item.product) : goToMixture(item.itemId)">
                  <ng-container *ngIf="item.product || item.mixture">
                    <img *ngIf="(item.product?.media?.[0]) || (item.mixture?.products?.[0]?.media?.[0])"
                         [src]="item.product?.media?.[0] ? 'data:' + item.product.media[0].contentType + ';base64,' + item.product.media[0].base64Data :
                               (item.mixture?.products?.[0]?.media?.[0] ? 'data:' + item.mixture.products[0].media[0].contentType + ';base64,' + item.mixture.products[0].media[0].base64Data : '')"
                         [alt]="item.product?.translatedName || item.mixture?.translatedName"/>
                  </ng-container>
                  <div *ngIf="!((item.product?.media?.[0]) || (item.mixture?.products?.[0]?.media?.[0]))"
                       class="no-image">
                    <mat-icon *ngIf="item.cartItemType === CartItemType.PRODUCT">inventory_2</mat-icon>
                    <mat-icon *ngIf="item.cartItemType === CartItemType.MIXTURE">blender</mat-icon>
                  </div>
                </div>

                <!-- Item Info -->
                <div class="item-info">
                  <div class="item-header">
                    <h3 class="item-name"
                        (click)="item.cartItemType === CartItemType.PRODUCT ? goToProduct(item.product) : goToMixture(item.itemId)">
                      {{ item.product?.translatedName || item.mixture?.translatedName }}
                    </h3>
                    <div class="item-price">{{ (item.product?.price || item.mixture?.price || 0) | swissCurrency }}</div>
                  </div>

                  <div class="item-description" *ngIf="item.product?.translatedDescription">
                    {{ truncateText(item.product.translatedDescription, 100) }}
                  </div>

                  <!-- Mixture Details -->
                  <div *ngIf="item.cartItemType === CartItemType.MIXTURE && item.mixture" class="mixture-display">
                    <h4>{{ 'CART.MIXTURE_CONTAINS' | translate }}</h4>
                    <div class="mixture-products-list">
                      <div *ngFor="let product of item.mixture.products" class="mixture-product-item">
                        <div class="mixture-product-info">
                          <div class="mixture-product-name">{{ product.translatedName }}</div>
                          <div class="mixture-product-price">{{ product.price | swissCurrency }}</div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Quantity Controls -->
                  <div class="item-controls">
                    <div class="item-quantity">
                      <label>{{ 'CART.QUANTITY' | translate }}:</label>
                      <div class="quantity-controls-container">
                        <div class="quantity-selector">
                          <button class="quantity-btn decrease"
                                  (click)="updateQuantity(item.itemId, (item.optimisticQuantity ?? item.quantity) - 1, item.cartItemType)"
                                  [disabled]="item.updating">
                            <mat-icon>remove</mat-icon>
                          </button>
                          <input #quantityInput type="number"
                                 [value]="item.optimisticQuantity ?? item.quantity"
                                 min="0"
                                 (change)="onQuantityChange($event, item)"
                                 [disabled]="item.updating"/>
                          <button class="quantity-btn increase"
                                  (click)="updateQuantity(item.itemId, (item.optimisticQuantity ?? item.quantity) + 1, item.cartItemType)"
                                  [disabled]="item.updating">
                            <mat-icon>add</mat-icon>
                          </button>
                        </div>
                        <div class="quantity-loading" *ngIf="item.updating">
                          <div class="spinner"></div>
                        </div>
                      </div>
                    </div>

                    <div class="item-total">
                      {{ getItemTotal(item) | swissCurrency }}
                    </div>
                  </div>
                </div>

                <!-- Remove Action -->
                <div class="item-actions">
                  <button mat-icon-button class="action-btn delete-btn"
                          (click)="removeItem(item.itemId)"
                          [title]="'CART.REMOVE' | translate"
                          [disabled]="item.updating">
                    <mat-icon>delete_outline</mat-icon>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Order Summary Sidebar -->
      <div class="order-sidebar" *ngIf="isCartLoaded && cartItemsWithDetails.length > 0">
        <!-- Order Summary -->
        <div class="form-section">
          <h3 class="section-subtitle">
            <mat-icon>receipt</mat-icon>
            {{ 'CART.ORDER_SUMMARY' | translate }}
          </h3>

          <div class="summary-card">
            <div class="summary-row">
              <span>{{ 'CART.SUBTOTAL' | translate }}:</span>
              <span>{{ getCartTotal() | swissCurrency }}</span>
            </div>

            <!-- Discount Section -->
            <div class="discount-section" *ngIf="!isDiscountApplied()">
              <mat-form-field appearance="outline" class="form-field full-width">
                <mat-label>{{ 'CART.DISCOUNT_CODE' | translate }}</mat-label>
                <input type="text"
                       [(ngModel)]="discountCode"
                       matInput
                       [placeholder]="'CART.DISCOUNT_PLACEHOLDER' | translate"
                       (keyup.enter)="applyDiscount()">
                <button mat-icon-button matSuffix
                        (click)="applyDiscount()"
                        [disabled]="!discountCode"
                        class="action-btn">
                  <mat-icon>local_offer</mat-icon>
                </button>
              </mat-form-field>
            </div>

            <!-- Applied Discount -->
            <div class="discount-applied" *ngIf="isDiscountApplied()">
              <div class="summary-row discount">
                <span>{{ 'CART.DISCOUNT' | translate }} ({{ cart?.discountCode }}):</span>
                <span>-{{ cart?.discount | swissCurrency }}</span>
              </div>
              <div class="remove-discount">
                <button mat-stroked-button
                        color="warn"
                        (click)="removeDiscount()"
                        class="remove-discount-btn">
                  <mat-icon>close</mat-icon>
                  {{ 'CART.REMOVE_DISCOUNT' | translate }}
                </button>
              </div>
            </div>

            <div class="summary-row total">
              <span>{{ 'CART.TOTAL' | translate }}:</span>
              <span>{{ getDiscountedTotal() | swissCurrency }}</span>
            </div>
          </div>
        </div>

        <!-- Checkout Action -->
        <div class="form-section">
          <button class="admin-create-btn"
                  mat-flat-button
                  (click)="proceedToCheckout()"
                  color="primary">
            <mat-icon>shopping_bag</mat-icon>
            {{ 'CART.CHECKOUT' | translate }}
          </button>
        </div>

        <!-- Continue Shopping -->
        <div class="form-section">
          <button class="back-btn"
                  mat-stroked-button
                  (click)="navigateHome()">
            <mat-icon>arrow_back</mat-icon>
            {{ 'CART.CONTINUE_SHOPPING' | translate }}
          </button>
        </div>
      </div>
    </div>
  </mat-card>
</div>
